<!doctype html>
<html style="height:100%">
<head>
    <link rel="stylesheet" href="http://xa-tools-hornet/css/site.css" type="text/css">
    <link rel="stylesheet" href="http://xa-tools-hornet/css/spreadgrid.css" type="text/css">
    <script src="http://xa-tools-hornet/grunt-scripts/lodash.min.js"></script>
    <script src="http://xa-tools-hornet/grunt-scripts/jquery.min.js"></script>
    <script src="http://xa-tools-hornet/grunt-scripts/spreadgrid.js"></script>
    <script src="http://xa-tools-hornet/grunt-scripts/globalize.js"></script>
    <script src="http://xa-tools-hornet/grunt-scripts/formatter.js"></script>
    <script src="http://xa-tools-hornet/grunt-scripts/functions.js"></script>
    <script src="scripts/CardLayoutEngine.js"></script>
    <link rel="stylesheet" href="css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="css/cardLayoutEngine.css" type="text/css">

    <style>
        .panel {
            background-color: transparent;
        }

        .glyphicon {
            font-size: 15px;
        }

        .file-selector {
            margin: 1px;
            position: relative;
            height: inherit;
        }

            .file-selector:hover {
                top: -1px;
                left: -1px;
                background-color: #cdeaff;
                border: 1px solid #66aaff;
            }

        .small-icons {
            margin-top: 4px;
            margin-left: 4px;
            width: 20px;
            height: 20px;
            float: left;
        }

        .small-file-title, .large-file-title, .date-modified, .file-type, .file-size {
            margin-top: 4px;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .small-file-title {
            margin-left: 10px;
            width: 180px;
            height: 20px;
            float: left;
        }

        .icons-small-file-folder {
            width: 20px;
            height: 20px;
            background: url("images/Generic-icon.png") 0 0 / 20px 20px no-repeat;
        }

        .icons-small-HTML {
            width: 20px;
            height: 20px;
            background: url("images/html-icon.png") 0 0 / 20px 20px no-repeat;
        }

        .icons-small-BMP {
            width: 20px;
            height: 20px;
            background: url("images/bmp-icon.png") 0 0 / 20px 20px no-repeat;
        }

        .icons-small-TXT {
            width: 20px;
            height: 20px;
            background: url("images/txt-icon.png") 0 0 / 20px 20px no-repeat;
        }

        .large-icons {
            width: 120px;
            height: 96px;
        }

        .large-file-title {
            text-align: center;
            width: 120px;
            height: 40px;
        }

        .icons-large-file-folder {
            width: 120px;
            height: 96px;
            background: url("images/Generic-icon.png") 17px 0 / 96px 96px no-repeat;
        }

        .icons-large-HTML {
            width: 120px;
            height: 96px;
            background: url("images/html-icon.png") 17px 0 / 96px 96px no-repeat;
        }

        .icons-large-BMP {
            width: 120px;
            height: 96px;
            background: url("images/bmp-icon.png") 17px 0 / 96px 96px no-repeat;
        }

        .icons-large-TXT {
            width: 120px;
            height: 96px;
            background: url("images/txt-icon.png") 17px 0 / 96px 96px no-repeat;
        }

        .date-modified {
            margin-left: 10px;
            width: 130px;
            height: 20px;
            float: left;
        }

        .file-type {
            margin-left: 20px;
            width: 80px;
            height: 20px;
            float: left;
        }

        .file-size {
            margin-left: 20px;
            width: 80px;
            height: 20px;
            float: left;
        }
        /*group header*/
        .gc-grouping-toggle {
            background: url('./images/sprite.png');
            border: 0;
        }

            .gc-grouping-toggle.expand {
                background-position: 0 -32px;
            }

            .gc-grouping-toggle.collapsed {
                background-position: 0 -16px;
            }
    </style>
</head>
<body style="height:95%;">

    <div class="panel">
        <div class="btn btn-default group-button" onclick="upToRootFolder();">
            <div class="glyphicon glyphicon-arrow-up"></div>
        </div>
        <div class="btn-group" role="group">
            <button class="btn btn-default" onclick="setGroupByName();">
                group by name
            </button>
            <button class="btn btn-default" onclick="setGroupByTime();">
                group by date
            </button>
            <button class="btn btn-default" onclick="setGroupByType();">
                group by type
            </button>
            <button class="btn btn-default" onclick="clearGroup();">
                clear group
            </button>
        </div>
        <div class="btn-group" role="group">
            <button class="btn btn-default" onclick="switchToLargeIcon()">
                <div class="glyphicon glyphicon-th-large"></div>
            </button>
            <button class="btn btn-default" onclick="switchToSmallIcon()">
                <div class="glyphicon glyphicon-th"></div>
            </button>
            <button class="btn btn-default" onclick="switchToDetail()">
                <div class="glyphicon glyphicon-th-list"></div>
            </button>
        </div>
        <br>
        <div class="btn" id="nav">aa</div>
    </div>
    <div style="height:600px;width:700px;">
        <div>
            <div id="grid1" style="height:528px;width:700px;padding:10px;border:0;"></div>
        </div>
    </div>

    <template id='smallIconViewTmpl'>
        <div class="file-selector">
            <div data-column="fileIcon" class="small-icons"></div>
            <div data-column="fileTitle" class="small-file-title"></div>
        </div>
    </template>

    <template id='largeIconViewTmpl'>
        <div class="file-selector">
            <div data-column="fileIcon" class="large-icons"></div>
            <div data-column="fileTitle" class="large-file-title"></div>
        </div>
    </template>

    <template id='detailViewTmpl'>
        <div class="file-selector">
            <div class="file-name">
                <div data-column="fileIcon" class="small-icons"></div>
                <div data-column="fileTitle" class="small-file-title"></div>
            </div>
            <div data-column="dateModified" class="date-modified"></div>
            <div data-column="fileType" class="file-type"></div>
            <div data-column="fileSize" class="file-size"></div>
        </div>
    </template>


    <script>
        var gcGrid;
        var smallIconColumns = [
            {
                'id': 'fileIcon',
                'dataField': 'fileIcon',
                'presenter': '<div class="icons-small-{{=it.fileIcon}}"></div>'
            },
            {
                'id': 'fileTitle',
                'dataField': 'name',
                'presenter': '<div>{{=it.name}}{{=it.extend}}</div>'
            },
            {
                'id': 'extend',
                'dataField': 'extend',
                'visible': false
            }
        ];
        var largeIconColumns = [
            {
                'id': 'fileIcon',
                'dataField': 'fileIcon',
                'presenter': '<div class="icons-large-{{=it.fileIcon}}"></div>'
            },
            {
                'id': 'fileTitle',
                'dataField': 'name',
                'presenter': '<div>{{=it.name}}{{=it.extend}}</div>'
            },
            {
                'id': 'extend',
                'dataField': 'extend',
                'visible': false
            }
        ];
        var detailColumns = [
            {
                'id': 'fileIcon',
                'dataField': 'fileIcon',
                'presenter': '<div class="icons-small-{{=it.fileIcon}}"></div>'
            },
            {
                'id': 'fileTitle',
                'dataField': 'name',
                'presenter': '<div>{{=it.name}}{{=it.extend}}</div>'
            },
            {
                'id': 'dateModified',
                'dataField': 'dateModified',
                'presenter': '<div>{{=it.dateModified}}</div>'
            },
            {
                'id': 'fileType',
                'dataField': 'type',
                'presenter': '<div>{{=it.type}}</div>'
            },
            {
                'id': 'fileSize',
                'dataField': 'sizeAmount',
                'presenter': '<div>{{=it.sizeAmount}} {{=it.sizeMeasure}}</div>'
            },
            {
                'id': 'sizeMeasure',
                'dataField': 'sizeMeasure',
                'visible': false
            },
            {
                'id': 'extend',
                'dataField': 'extend',
                'visible': false
            }
        ];

        var currentPath = './';
        $(document).ready(function () {
            $.getJSON("database/fileList.json", function (data) {
                gcGrid = new GcSpread.Views.GcGrid(document.getElementById('grid1'), data, detailColumns, new GcSpread.Views.GcGrid.Plugins.CardLayoutEngine({
                    cardHeight: 30,
                    cardWidth: 600,
                    rowTemplate: "#detailViewTmpl",
                    direction: 'horizontal',
                    grouping: {
                        field: 'fileType',
                        header: {
                            template: '<div class="gc-group-header-cell gc-group-header" style="line-height:24px;">' +
                            '<span class="gc-grouping-toggle {{=it.groupStatus}}" style="margin-left:{{=it.margin}}px;"></span>' +
                            '<span level="{{=it.level}}"><b>{{=it.name}}</b><span> ({{=it.count}})</span></span>' +
                            '</div>',
                            height: 24
                        }
                    }
                }));
                setFilter(currentPath);
                gcGrid.onMouseDbClick.addHandler(handleMouseDbClick);
            })
        });

        //handle dir change:
        function handleMouseDbClick(sender, event) {
            var grid = sender;
            var hitTestInfo = grid.layoutEngine.hitTest(event);
            var groupInfo;
            var i;
            var len;
            var item;
            var path;
            var currentGroup;
            var groups = grid.data.groups;
            if (groups) {
                groupInfo = hitTestInfo.groupInfo
                path = groupInfo.path;
                currentGroup = groups[path[0]];
                for (i = 1, len = path.length; i < len; i++) {
                    currentGroup = currentGroup.children[path[i]];
                }
                var row = groupInfo.row;
                item = currentGroup.getItem(row);
            } else {
                row = hitTestInfo.row;
                item = grid.getDataItem(row);
            }
            if (item.type === 'File folder') {
                openFolder(item.name);
            }
        }
        function openFolder(str) {
            currentPath += str + '/';
            setFilter(currentPath);
        }
        function upToRootFolder() {
            var chunk = /[^/]*\/$/;
            var result = chunk.exec(currentPath);
            var len = result ? (result[0] ? result[0].length : 0) : 0;
            var cLen = currentPath.length;
            if (cLen > len && len > -1) {
                currentPath = currentPath.slice(0, cLen - len);
            }
            setFilter(currentPath);
        }
        function setFilter(str) {
            gcGrid.data.filter('[path]="' + str + '"').do();
            var nav = document.getElementById('nav');
            nav.innerHTML = str;
        }

        //handle layout change:
        function switchToLargeIcon() {
            gcGrid.columns = largeIconColumns;
            var options = gcGrid.options;
            options.cardHeight = 140;
            options.cardWidth = 120;
            options.rowTemplate = '#largeIconViewTmpl';
            gcGrid.invalidate();
        }
        function switchToSmallIcon() {
            gcGrid.columns = smallIconColumns;
            var options = gcGrid.options;
            options.cardHeight = 30;
            options.cardWidth = 220;
            options.rowTemplate = '#smallIconViewTmpl';
            gcGrid.invalidate();
        }
        function switchToDetail() {
            gcGrid.columns = detailColumns;
            var options = gcGrid.options;
            options.cardHeight = 30;
            options.cardWidth = 600;
            options.rowTemplate = '#detailViewTmpl';
            gcGrid.invalidate();
        }

        //handle group:
        function setGroupByName() {
            gcGrid.data.groupDescriptors = null;
            gcGrid.data.groupDescriptors = [{
                field: 'fileTitle',
                header: {
                    template: '<div class="gc-group-header-cell gc-group-header" style="line-height:24px;">' +
                    '<span class="gc-grouping-toggle {{=it.groupStatus}}" style="margin-left:{{=it.margin}}px;"></span>' +
                    '<span level="{{=it.level}}"><b>{{=it.name}}</b><span> ({{=it.count}})</span></span>' +
                    '</div>',
                    height: 24
                },
                converter: function (field) {
                    var initial = field[0].toUpperCase();
                    return (initial >= 'Q' && initial <= 'Z') ? 'Q - Z' :
                        (initial >= 'I' && initial <= 'P') ? 'I - P' :
                            (initial >= 'A' && initial <= 'H') ? 'A - H' :
                                (initial >= '0' && initial <= '9') ? '0-9' : 'others';
                }
            }];
        }
        function setGroupByTime() {
            gcGrid.data.groupDescriptors = null;
            gcGrid.data.groupDescriptors = [{
                field: 'dateModified',
                header: {
                    template: '<div class="gc-group-header-cell gc-group-header" style="line-height:24px;">' +
                    '<span class="gc-grouping-toggle {{=it.groupStatus}}" style="margin-left:{{=it.margin}}px;"></span>' +
                    '<span level="{{=it.level}}"><b>{{=it.name}}</b><span> ({{=it.count}})</span></span>' +
                    '</div>',
                    height: 24
                },
                converter: function (field) {
                    var modifiedDay = new Date(field);
                    var today = new Date();
                    today.setHours(0);
                    today.setMinutes(0);
                    today.setSeconds(0);
                    today.setMilliseconds(0);
                    modifiedDay.setHours(0);
                    modifiedDay.setMinutes(0);
                    modifiedDay.setSeconds(0);
                    modifiedDay.setMilliseconds(0);
                    var yearDiff = today.getFullYear() - modifiedDay.getFullYear();
                    var monthDiff = today.getMonth() - modifiedDay.getMonth();
                    var dateDiff = Math.floor((today - modifiedDay) / 1000 / 60 / 60 / 24);
                    return yearDiff > 1 ? 'years ago' :
                        yearDiff === 1 ? 'last year' :
                            monthDiff > 1 ? 'early in this year' :
                                dateDiff > 7 ? 'this month' :
                                    dateDiff > 1 ? 'this week' : 'today';
                }
            }];
        }
        function setGroupByType() {
            gcGrid.data.groupDescriptors = null;
            gcGrid.data.groupDescriptors = [{
                field: 'fileType',
                header: {
                    template: '<div class="gc-group-header-cell gc-group-header" style="line-height:24px;">' +
                    '<span class="gc-grouping-toggle {{=it.groupStatus}}" style="margin-left:{{=it.margin}}px;"></span>' +
                    '<span level="{{=it.level}}"><b>{{=it.name}}</b><span> ({{=it.count}})</span></span>' +
                    '</div>',
                    height: 24
                }
            }];
        }
        function clearGroup() {
            gcGrid.data.groupDescriptors = null;
        }
    </script>


</body>
</html>
