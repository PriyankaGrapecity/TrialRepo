<!doctype html>
<html style="height:100%">
<head>
    <link rel="stylesheet" href="http://xa-tools-hornet/css/site.css" type="text/css">
    <link rel="stylesheet" href="http://xa-tools-hornet/css/spreadgrid.css" type="text/css">
    <script src="http://xa-tools-hornet/grunt-scripts/lodash.min.js"></script>
    <script src="http://xa-tools-hornet/grunt-scripts/jquery.min.js"></script>
    <script src="http://xa-tools-hornet/grunt-scripts/spreadgrid.js"></script>
    <script src="http://xa-tools-hornet/grunt-scripts/globalize.js"></script>
    <script src="http://xa-tools-hornet/grunt-scripts/formatter.js"></script>
    <script src="http://xa-tools-hornet/grunt-scripts/functions.js"></script>
    <script src="http://xa-tools-shdev/widget/cdn/scripts/gcspread.sheets.all.8.40.20151.0.min.js"></script>
    <script src="scripts/calc.js"></script>
    <script src="scripts/functions.js"></script>
    <link rel="stylesheet" href="http://xa-tools-shdev/widget/cdn/css/gcspread.sheets.8.40.20151.0.css" type="text/css">

    <style>
        .grid {
            height: 600px;
        }

        .percent-complete-bar {
            display: inline-block;
            height: 6px;
            -moz-border-radius: 3px;
            -webkit-border-radius: 3px;
        }

        .well {
            padding: 0;
        }
    </style>
</head>
<body style="height:95%;">

    <div id="grid1" class="grid" style="height:450px">
    </div>
    <div id="grid2" class="grid" style="height:200px">
    </div>


    <script>
        $.getJSON("database/salesData_small.json", function (data) {
            var spread = new GcSpread.Sheets.Spread(document.getElementById('grid1'), { sheetCount: 1 });
            spread.newTabVisible(false);
            spread.autoFitType(GcSpread.Sheets.AutoFitType.CellWithHeader);
            var sheet = spread.getSheet(0);
            sheet.setName('orders');
            sheet.autoGenerateColumns = true;
            sheet.setDataSource(data);

            var dataColumns = [
                { name: "productName", field: "productName" },
                { name: "quantity", field: "quantity" },
                { name: "salesDate", field: "salesDate" },
                { name: "salesMan", field: "salesMan" },
                { name: "unitPrice", field: "unitPrice" },
                { name: "country", field: "country" },
                { name: "region", field: "region" },
            ];

            for (var c = 0, len = dataColumns.length; c < len; c++) {
                sheet.autoFitColumn(c);
            }

            var sheetDataSource = {};
            sheetDataSource.getColumns = function () {
                return dataColumns;
            };
            sheetDataSource.getDataItem = function (index) {
                var item = {};
                for (var c = 0, len = dataColumns.length; c < len; c++) {
                    item[dataColumns[c].field] = sheet.getValue(index, c);
                }
                return item;
            };
            sheetDataSource.getDimension = function () {
                return sheet.getRowCount();
            };

            var calc = GcSpread.Views.Calc;
            var calcSource = new calc.CalcSource('orders', sheetDataSource);
            var parseContext = new calc.ParserContext(calcSource);
            var evaluateContext = new calc.EvaluatorContext(calcSource);
            var evaluator = new calc.Evaluator();

            var daxSpread = new GcSpread.Sheets.Spread(document.getElementById('grid2'), { sheetCount: 1 });
            daxSpread.showHorizontalScrollbar(false);
            daxSpread.tabStripVisible(false);
            daxSpread.newTabVisible(false);
            daxSpread.canUserEditFormula(false);
            var daxSheet = daxSpread.getSheet(0);
            daxSheet.setName('dax formula');
            daxSheet.rowHeaderVisible = false;
            daxSheet.setColumnCount(2);
            daxSheet.setText(0, 0, "DAX Formula", GcSpread.Sheets.SheetArea.colHeader);
            daxSheet.setText(0, 1, "Result", GcSpread.Sheets.SheetArea.colHeader);
            daxSheet.setColumnWidth(0, 600, GcSpread.Sheets.SheetArea.colHeader);
            daxSheet.setColumnWidth(1, 100, GcSpread.Sheets.SheetArea.colHeader);
            var cellChanged = GcSpread.Sheets.Events.CellChanged;
            daxSheet.bind(cellChanged, function (e, args) {
                if (args.propertyName === 'value' && args.col === 0) {
                    var formula = daxSheet.getText(args.row, args.col);
                    var result = evaluator.evaluateFormula(formula, parseContext, evaluateContext);
                    daxSheet.setValue(args.row, 1, result);
                }
            });
            daxSheet.setValue(0, 0, '=CALCULATE(SUM([quantity] * [unitPrice]), FILTER([salesMan]="Bob" && [productName]="iphone5s"))');
            sheet.bind(cellChanged, function (e, args) {
                if (args.propertyName === 'value') {
                    for (var r = 0, rowCount = daxSheet.getRowCount() ; r < rowCount; r++) {
                        var formula = daxSheet.getText(r, 0);
                        if (formula) {
                            var result = evaluator.evaluateFormula(formula, parseContext, evaluateContext);
                            daxSheet.setValue(r, 1, result);
                        }
                    }
                }
            });
        });
    </script>


</body>
</html>
