<!doctype html>
<html style="height:100%">
<head>
    <link rel="stylesheet" href="http://xa-tools-hornet/css/site.css" type="text/css">
    <link rel="stylesheet" href="http://xa-tools-hornet/css/spreadgrid.css" type="text/css">
    <script src="http://xa-tools-hornet/grunt-scripts/lodash.min.js"></script>
    <script src="http://xa-tools-hornet/grunt-scripts/jquery.min.js"></script>
    <script src="http://xa-tools-hornet/grunt-scripts/spreadgrid.js"></script>
    <script src="http://xa-tools-hornet/grunt-scripts/globalize.js"></script>
    <script src="http://xa-tools-hornet/grunt-scripts/formatter.js"></script>
    <script src="http://xa-tools-hornet/grunt-scripts/functions.js"></script>
    <script src="scripts/MasonryLayoutEngine.js"></script>
    <link rel="stylesheet" href="css/bootstrap.min.css" type="text/css">
    <link rel="stylesheet" href="css/MasonryLayoutEngine.css" type="text/css">

    <style>
        .post-wrapper {
            border: 1px solid;
            border-color: #e5e6e9 #dfe0e4 #d0d1d5;
            border-radius: 3px;
            -webkit-border-radius: 3px;
            -ms-border-radius: 3px;
            background-color: white;
            color: #141823;
            width: 452px;
            margin: 0 5px 10px 0;
        }

        .user-content-wrapper {
            padding: 12px 12px 0 12px;
        }

        .block-wrapper {
            margin-bottom: 10px;
        }

        .user-icon {
            display: inline-block;
            margin-right: 10px;
        }

        .user-stamp {
            vertical-align: top;
            display: inline-block;
        }

        .user-stamp-name {
            display: inline-block;
        }

        .user-story {
            display: inline-block;
        }

        .user-stamp-time {
            display: inline-block;
        }

        .comment-link {
            display: inline-block;
            margin-top: 10px;
            font-size: 12px;
            color: #9197a3;
        }

            .comment-link:hover {
                color: #828793;
                text-decoration: none;
            }

        .interface-icons-wrapper {
            padding-top: 10px;
            margin-top: 10px;
            border-top: 1px solid #e1e2e3;
        }

        .interface-icons {
            display: table-cell;
        }

        .comment-icon-link {
            margin-right: 30px;
            color: #7f7f7f;
            cursor: pointer;
        }

            .comment-icon-link:hover {
                text-decoration: underline;
            }

        .icon-checked {
            color: #5890ff;
        }

        .comments {
            border-top: 1px solid #e1e2e3;
            background-color: #f6f7f8;
            margin-top: 10px;
        }

        .comment-item {
            padding: 3px 12px 3px 12px;
            overflow: hidden;
            word-wrap: break-word;
        }

        .small-icon {
            width: 32px;
            height: 32px;
        }

        .comment-item-message {
            padding-left: 8px;
            overflow: hidden;
        }

        .user-name {
            font-weight: bold;
            color: #3b5998;
        }
    </style>
</head>
<body style="height:95%;">

    <div id="grid1" style="height:100%"></div>

    <template id='rowTemplate'>
        <div class="post-wrapper">
            <div class="user-content-wrapper">
                <div class="block-wrapper">
                    <div class="user-icon" data-column="icon"></div>
                    <div class="user-stamp">
                        <div>
                            <span class="user-stamp-name" data-column="name"></span>
                            <span class="user-story" data-column="story"></span>
                        </div>
                        <span class="user-stamp-time" data-column="created_time"></span>
                    </div>
                </div>
                <div data-column="message"></div>
                <div>
                    <div data-column="img"></div>
                    <div data-column="video"></div>
                </div>
                <div data-column="comment_link"></div>
                <div>
                    <div class="interface-icons-wrapper">
                        <div data-column="like" class="interface-icons"></div>
                        <div class="interface-icons">
                            <a class="comment-icon-link icon-link-comment"><div class="glyphicon glyphicon-comment"></div>&nbspcomment</a>
                        </div>
                        <div class="interface-icons">
                            <a class="comment-icon-link icon-link-share"><div class="glyphicon glyphicon-share-alt"></div>&nbspshare</a>
                        </div>
                    </div>
                </div>
            </div>
            <div data-column="commentUI" class="comments"></div>
        </div>
    </template>


    <script>
        var gcGrid;
        var data;
        var columns = [
            { id: 'icon', name: 'icon', dataField: 'icon', presenter: '<a href="{{=it.icon}}"><img src="{{=it.icon}}" style="width:40px;height:40px;"></a>' },
            { id: 'created_time', name: 'created_time', dataField: 'created_time', format: 'mm-dd-yyyy' },
            { id: 'story', name: 'story', dataField: 'story' },
            { id: 'name', name: 'name', dataField: 'name', presenter: '<a class="user-name">{{=it.name}}</a>' },
            { id: 'message', name: 'message', dataField: 'message' },
            {
                id: 'comment_link',
                name: 'comment_link',
                dataField: 'comment_link',
                presenter: '<a class="comment-link">' +
                '<span>{{=(it.total_likes + (it.like ? 1 : 0))}}{{?(it.total_likes + (it.like ? 1 : 0)) <= 1}}like{{??(it.total_likes + (it.like ? 1 : 0)) > 1}}likes{{?}}</span>&nbsp&nbsp' +
                '<span>{{=it.total_comments}}{{?it.total_comments <= 1}}comment{{??it.total_comments > 1}}comments{{?}}</span>&nbsp&nbsp' +
                '<span>{{=it.total_shares}}{{?it.total_shares <= 1}}share{{??it.total_shares > 1}}shares{{?}}</span>' +
                '</a>'
            },
            { id: 'like', name: 'like', dataField: 'like', presenter: '<a class="comment-icon-link icon-link-like {{?it.like}}icon-checked{{?}}"><div class="glyphicon glyphicon-thumbs-up"></div>&nbsplike</a>' },
            {
                id: 'img',
                name: 'img',
                dataField: 'img',
                presenter: '<div>{{~it.img:value:index}}' +
                '<div class="img-item">' +
                '<img src="{{=value.url}}" style="width:426px;" alt="{{=value.name}}">' +
                '</div>' +
                '{{~}}</div>'
            },
            {
                id: 'video',
                name: 'video',
                dataField: 'video',
                presenter: '<div>{{~it.video:value:index}}' +
                '<div class="video-item">' +
                '<video style="width:426px;height:243px" controls>' +
                '<source src="{{=value.url}}" type="video/mp4">' +
                '</video>' +
                '</div>' +
                '{{~}}</div>'
            },
            {
                id: 'commentUI',
                name: 'commentUI',
                dataField: 'commentUI',
                presenter: '{{?it.show_comment}}<div>{{~it.comments:value:index}}' +
                '<div class="comment-item">' +
                '<div style="float:left"><img class="small-icon" src="{{=value.icon}}"></div>' +
                '<div><div class="comment-item-message"><a class="user-name">{{=value.name}}:</a>&nbsp{{=value.message}}</div></div>' +
                '</div>' +
                '{{~}}</div>{{?}}'
            },
            { id: 'total_likes', name: 'total_likes', dataField: 'total_likes', visible: false },
            { id: 'total_comments', name: 'total_comments', dataField: 'total_comments', visible: false },
            { id: 'total_shares', name: 'total_shares', dataField: 'total_shares', visible: false },
            { id: 'comments', name: 'comments', dataField: 'comments', visible: false },
            { id: 'show_comment', name: 'show_comment', dataField: 'show_comment', visible: false }
        ];

        $(document).ready(function () {
            $.getJSON("database/comments.json", function (currData) {
                data = currData;
                gcGrid = new GcSpread.Views.GcGrid(document.getElementById('grid1'), data, columns, new GcSpread.Views.GcGrid.Plugins.MasonryLayoutEngine({
                    rowTemplate: '#rowTemplate'
                }));
                gcGrid.onMouseDown.addHandler(handleMouseDown);
            })
        });

        function handleMouseDown(sender, event) {
            var grid = sender;
            var layoutEngine = grid.layoutEngine;
            var hitTestInfo = layoutEngine.hitTest(event);
            var row = hitTestInfo.row;
            var targetList = ['.icon-link-like', '.icon-link-comment'];
            var i = lookupForElementNames(event, targetList);
            if (i === 0) {
                data[row].like = !data[row].like;
                grid.layoutEngine.remeasureItem(row);
            } else if (i === 1) {
                if (data[row].video) {
                    return;
                }
                data[row].show_comment = !data[row].show_comment;
                grid.layoutEngine.remeasureItem(row);
            }

            // return the matched name index
            function lookupForElementNames(event, targetNameSet) {
                var element = event.target;
                while (element) {
                    // get the first match in the name set
                    for (var i = 0, len = targetNameSet.length; i < len; ++i) {
                        if (matchName(element, targetNameSet[i])) {
                            return i;
                        }
                    }
                    element = element.parentNode;
                }
                return -1;
            }

            function matchName(element, name) {
                if (typeof name === 'string') {
                    var initial = name[0];
                    var str = '';
                    switch (initial) {
                        case '.':
                            if (!element.classList) {
                                return false;
                            }
                            str = name.slice(1).toLowerCase();
                            for (var i = 0, len = element.classList.length; i < len; ++i) {
                                if (element.classList[i].toLowerCase() === str) {
                                    return true;
                                }
                            }
                            return false;
                        case '#':
                            str = name.slice(1).toLowerCase();
                            return !!element.id && element.id.toLowerCase() === str;
                            break;
                        default:
                            str = name.toLowerCase();
                            return element.tagName.toLowerCase() === str;
                    }
                }
            }
        }
    </script>


</body>
</html>
