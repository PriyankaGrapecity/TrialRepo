<!doctype html>
<html style="height:100%">
<head>
    <link rel="stylesheet" href="http://xa-tools-hornet/css/site.css" type="text/css">
    <link rel="stylesheet" href="http://xa-tools-hornet/css/spreadgrid.css" type="text/css">
    <script src="http://xa-tools-hornet/grunt-scripts/lodash.min.js"></script>
    <script src="http://xa-tools-hornet/grunt-scripts/jquery.min.js"></script>
    <script src="http://xa-tools-hornet/grunt-scripts/spreadgrid.js"></script>
    <script src="http://xa-tools-hornet/grunt-scripts/globalize.js"></script>
    <script src="http://xa-tools-hornet/grunt-scripts/formatter.js"></script>
    <script src="http://xa-tools-hornet/grunt-scripts/functions.js"></script>

    <style>
        /*override origin css*/
        .gc-grid, .gc-cell {
            border: 0;
            white-space: normal;
            text-overflow: clip;
            background-color: transparent;
        }
        /*product presentation:*/
        .product-header {
            font-size: 18px;
            text-align: right;
            margin-right: 28px;
        }

        .product-divide {
            border-bottom: 1px solid rgba(0,0,0,0.2);
        }

        .product-item {
            display: inline-block;
            width: 400px;
        }

        .product-item-image {
            vertical-align: top;
            display: inline-block;
            width: 100px;
        }

        .product-item-image-resize {
            width: 80px;
            height: 100px;
        }

        .product-item-details {
            width: 300px;
            vertical-align: top;
            display: inline-block;
        }

        .product-price, .product-quantity {
            width: 75px;
            vertical-align: top;
            text-align: center;
            display: inline-block;
        }

        .product-subtotal {
            width: 120px;
            vertical-align: top;
            text-align: center;
            display: inline-block;
        }

        .product-quantity-number {
            height: 30px;
        }

        .product-total {
            font-size: 22px;
            text-align: right;
            margin-right: 28px;
        }
    </style>
</head>
<body style="height:95%;">

    <div style="height:600px;width:700px;">
        <div>
            <div class="product-header">
                <span style="margin-right: 40px">price</span>
                <span style="margin-right: 30px">subtotal</span>
                <span>quantity</span>
            </div>
            <div class="product-divide"></div>
            <div id="grid1" style="height:528px;width:700px;padding:10px;border:0;"></div>
            <div class="product-divide"></div>
            <div id="total" class="product-total"></div>
        </div>
    </div>
    <template id='rowTmpl'>
        <div>
            <div class="product-item">
                <div data-column="productImage" class="product-item-image"></div>
                <div class="product-item-details">
                    <div data-column="productTitle"></div>
                </div>
            </div>
            <div data-column="productPrice" class="product-price"></div>
            <div data-column="productSubtotal" class="product-subtotal"></div>
            <div class="product-quantity">
                <div data-column="productQuantity" class="product-quantity-number"></div>
                <div data-column="productQuantityEdit"></div>
            </div>
        </div>
    </template>


    <script>
        var gcGrid;
        var columns = [
            {
                'id': 'productImage',
                'dataField': 'productImageUrl,productLink,productTitle',
                'allowEditing': false,
                'presenter': '<a href="{{=it.link}}"><img class="product-item-image-resize" src="{{=it.url}}" alt="{{=it.title}}"></a>'
            },
            {
                'id': 'productTitle',
                'allowEditing': false,
                'dataField': 'title'
            },
            {
                'id': 'productPrice',
                'allowEditing': false,
                'dataField': 'price',
                'format': '$#,##0.00'
            },
            {
                'id': 'productSubtotal',
                'allowEditing': false,
                'dataField': '=[productPrice] * [productQuantity]',
                'presenter': '<span style="color:red;">{{=it.productSubtotal}}</span>',
                'format': '$#,##0.00'
            },
            {
                'id': 'productQuantity',
                'dataField': 'quantity'
            },
            {
                'id': 'productQuantityEdit',
                'action': [
                    {
                        'name': 'edit',
                        'presenter': '<button data-action="edit" class="btn btn-default edit-btn">Edit</button>'
                    }
                ]
            },
            {
                id: 'productDelete',
                action: [
                  {
                      name: 'delete',
                      presenter: '<div data-action = "delete" style = "background-color:red;color:white;width:80px;height:100%;position:relative"><span style = "position:absolute;left:30%;top:40%">Delete</span></div>',
                      handler: deleteRow
                  }
                ],
                width: 80,
                swipeDirection: 'left'
            },
            { 'id': 'productImageUrl', 'visible': false, 'dataField': 'url' },
            { 'id': 'productLink', 'visible': false, 'dataField': 'link' },
            { 'id': 'discountThreshold', 'visible': false, 'dataField': 'discountThreshold' }
        ];

        var calc = GcSpread.Views.Calc;
        var evaluator = new calc.Evaluator();
        var calcSource;
        var parseContext;
        var evaluateContext;

        $(document).ready(function () {
            $.getJSON("database/shoppingCartItems.json", function (data) {
                gcGrid = new GcSpread.Views.GcGrid(document.getElementById('grid1'), data, columns, {
                    rowHeight: 127,
                    showRowHeader: false,
                    showColHeader: false,
                    showGroupFooter: false,
                    selectionMode: "none",
                    allowEditing: true,
                    allowSwipe: true,
                    rowTemplate: '#rowTmpl'
                });

                calcSource = gcGrid.data.calcSource;
                parseContext = new calc.ParserContext(calcSource);
                evaluateContext = new calc.EvaluatorContext(calcSource);

                refreshTotalPrice();

                gcGrid.editing.addHandler(function (sender, args) {
                    if (args.status === 'endEditing') {
                        refreshTotalPrice();
                    }
                });
            });
        });

        var formulaStringTotal = 'if(sum([productSubtotal]) > 199.99, sum([productSubtotal]) * 0.6, sum([productSubtotal]))';
        var formulaStringPrice = 'sum([productSubtotal])';
        var formulaStringQuantity = 'sum([productQuantity])';

        function refreshTotalPrice() {
            var total = evaluator.evaluateFormula(formulaStringTotal, parseContext, evaluateContext);
            var price = evaluator.evaluateFormula(formulaStringPrice, parseContext, evaluateContext);
            var saving = price - total;
            var quantity = evaluator.evaluateFormula(formulaStringQuantity, parseContext, evaluateContext);
            var totalPriceSpan = document.getElementById('total');
            totalPriceSpan.innerHTML = '<div>total (' + quantity + ' items): ' + '<span style="color:red">$' + total.toFixed(2) + '</span></div>' +
            '<div><span style="font-size: 16px">total saving: </span><span style="color:red">$' + saving.toFixed(2) + '</span><span>(' + (saving / price * 100).toFixed(0) + '%)</span></div>';
        }

        function deleteRow(args) {
            var answer = confirm('Are you sure to delete row?');
            if (answer) {
                gcGrid.data.removeItem(args.hitInfo.row);
                gcGrid.invalidate();
                refreshTotalPrice();
            }
            args.closeActionColumnPanel();
        }
    </script>


</body>
</html>
