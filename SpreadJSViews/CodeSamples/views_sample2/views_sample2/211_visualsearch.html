<!doctype html>
<html style="height:100%">
<head>
    <link rel="stylesheet" href="http://xa-tools-hornet/css/site.css" type="text/css">
    <link rel="stylesheet" href="http://xa-tools-hornet/css/spreadgrid.css" type="text/css">
    <script src="http://xa-tools-hornet/grunt-scripts/lodash.min.js"></script>
    <script src="http://xa-tools-hornet/grunt-scripts/jquery.min.js"></script>
    <script src="http://xa-tools-hornet/grunt-scripts/spreadgrid.js"></script>
    <script src="http://xa-tools-hornet/grunt-scripts/globalize.js"></script>
    <script src="http://xa-tools-hornet/grunt-scripts/formatter.js"></script>
    <script src="http://xa-tools-hornet/grunt-scripts/functions.js"></script>
    <script src="scripts/backbone-1.1.0.js"></script>
    <script src="scripts/jquery.ui.core.js"></script>
    <script src="scripts/jquery.ui.widget.js"></script>
    <script src="scripts/jquery.ui.position.js"></script>
    <script src="scripts/jquery.ui.menu.js"></script>
    <script src="scripts/jquery.ui.autocomplete.js"></script>
    <script src="scripts/visualsearch.js"></script>
    <link rel="stylesheet" href="css/visualsearch-datauri.css" type="text/css">
    <link rel="stylesheet" href="css/visualsearch.css" type="text/css">

    <style>
        .grid {
            height: 90%;
        }

        .command-container {
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
            margin-right: 30px;
            height: 50px;
        }
    </style>
</head>
<body style="height:95%;">

    <div class="command-container">
        <div class="visual_search"></div>
    </div>
    <div id="grid1" class="grid"></div>


    <script>
        $(function () {
            $.getJSON("data/salesData_small.json", function (data) {
                var gcGrid = new GcSpread.Views.GcGrid(document.getElementById('grid1'), data, null);
                var data = gcGrid.data;
                var calcSource = data.calcSource;
                var evaluator = calcSource.getEvaluator();
                var parserContext = calcSource.getParserContext();
                var evaluatorContext = calcSource.getEvaluatorContext();

                var facetDic = {};

                var items = evaluator.evaluateFormula('=distinct([region])', parserContext, evaluatorContext).toArray();
                var regionValues = _.map(items, function (item) {
                    return item.region;
                });
                facetDic['region'] = regionValues;

                items = evaluator.evaluateFormula('=distinct([country])', parserContext, evaluatorContext).toArray();
                var countryValues = _.map(items, function (item) {
                    return item.country;
                });
                facetDic['country'] = countryValues;

                items = evaluator.evaluateFormula('=distinct([salesMan])', parserContext, evaluatorContext).toArray();
                var salesManValues = _.map(items, function (item) {
                    return item.salesMan;
                });
                facetDic['salesMan'] = salesManValues;

                items = evaluator.evaluateFormula('=distinct([productName])', parserContext, evaluatorContext).toArray();
                var productNameValues = _.map(items, function (item) {
                    return item.productName;
                });
                facetDic['productName'] = productNameValues;
                var keys = _.keys(facetDic);

                var visualSearch = VS.init({
                    container: $('.visual_search'),
                    query: '',
                    callbacks: {
                        search: function (query, searchCollection) {
                            var facets = visualSearch.searchQuery.facets();
                            var filterExpr = '';
                            _.forEach(facets, function (facet) {
                                var facetKeys = _.keys(facet);
                                _.forEach(facetKeys, function (key) {
                                    var facetExpr = '[' + key + ']="' + facet[key] + '"';
                                    if (filterExpr) {
                                        filterExpr += '&&';
                                    }
                                    filterExpr += facetExpr;
                                });
                            });
                            gcGrid.data.filterExpression = filterExpr;
                        },
                        facetMatches: function (callback) {
                            callback(keys);
                        },
                        valueMatches: function (facet, searchTerm, callback) {
                            var facetValues = facetDic[facet];
                            return callback(facetValues)
                        }
                    }
                });
            });
        });
    </script>


</body>
</html>
